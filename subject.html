<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© - Ù…Ù†ØµØ© Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©</title>
    <link rel="icon" href="img/logo.jpg" type="image/jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css?v=1.3">
    <!-- Load Appwrite SDK and Config -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="js/appwrite-config.js?v=1.1"></script>
    <script src="js/db-appwrite.js?v=1.1"></script>
    <script src="js/security.js?v=2.0"></script>
    <script>
        // Global Security logic included via security.js

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const subjects = {
            'math': { name: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', icon: 'ğŸ“' },
            'geo': { name: 'Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§', icon: 'ğŸŒ' },
            'eng': { name: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', icon: 'ğŸ‡¬ğŸ‡§' },
            'fr': { name: 'Ø§Ù„Ù„ØºØ© Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©', icon: 'ğŸ‡«ğŸ‡·' }
        };

        async function renderDynamicMaterials(subjectId) {
            try {
                await window.dbInit();
                const materials = await window.dbGetAll();
                const subjectMaterials = materials.filter(m => m.subjectId === subjectId);

                ['videos', 'pdfs', 'sheets', 'exams'].forEach(sectionId => {
                    const container = document.getElementById(sectionId);
                    const items = subjectMaterials.filter(m => m.sectionId === sectionId);

                    if (items.length > 0) {
                        container.innerHTML = '';

                        items.forEach(item => {
                            let icon = 'ğŸ“„';
                            let btnLabel = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù';
                            let isVideo = sectionId === 'videos';

                            if (isVideo) {
                                icon = 'â–¶ï¸';
                                btnLabel = 'Ù…Ø´Ø§Ù‡Ø¯Ø©';
                            }

                            const div = document.createElement('div');
                            div.className = 'material-item';

                            const infoDiv = document.createElement('div');
                            infoDiv.className = 'material-info';

                            const iconDiv = document.createElement('div');
                            iconDiv.className = 'material-icon';
                            iconDiv.textContent = icon;

                            const textDiv = document.createElement('div');
                            const h3 = document.createElement('h3');
                            h3.textContent = item.title;
                            const p = document.createElement('p');
                            p.style.color = '#666';
                            p.style.fontSize = '0.9rem';
                            p.textContent = item.desc || '';

                            textDiv.appendChild(h3);
                            textDiv.appendChild(p);
                            infoDiv.appendChild(iconDiv);
                            infoDiv.appendChild(textDiv);

                            const btn = document.createElement('button');
                            btn.className = 'action-btn';
                            btn.textContent = btnLabel;

                            btn.addEventListener('click', () => {
                                try {
                                    let effectiveUrl = item.url;
                                    if (item.isBlob || (item.url && typeof item.url === 'object')) {
                                        try { effectiveUrl = URL.createObjectURL(item.url); } catch (e) { }
                                    }

                                    if (isVideo) {
                                        window.openSecureVideo(effectiveUrl);
                                    } else {
                                        window.openSecurePDF(effectiveUrl);
                                    }
                                } catch (clickErr) {
                                    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø±: " + clickErr.message);
                                }
                            });

                            div.appendChild(infoDiv);
                            div.appendChild(btn);
                            container.appendChild(div);
                        });
                    } else {
                        container.innerHTML = `<p style="text-align:center; color:#777; margin-top:2rem;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.
    </p>`;
                    }
                });
            } catch (err) {
                alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: " + err.message);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (window.initSecurity) window.initSecurity();
            const userEmail = localStorage.getItem('user_email');
            const displayName = localStorage.getItem('user_display_name');

            if (!userEmail) {
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('welcomeMsg').textContent = `Ù…Ø±Ø­Ø¨Ø§ØŒ ${displayName || 'Ø·Ø§Ù„Ø¨'}`;


            const subjectId = getQueryParam('id');
            const subjectData = subjects[subjectId];

            // --- Permission Check ---
            const permittedStr = localStorage.getItem('user_permitted_subjects') || "";
            const permitted = permittedStr.split(',').filter(s => s);

            if (!permitted.includes(subjectId)) {
                alert("â›” ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ùƒ Ø¨Ø¯Ø®ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.");
                window.location.href = 'dashboard.html';
                return;
            }

            if (subjectData) {
                document.getElementById('subjectTitle').textContent = subjectData.name;
                document.getElementById('subjectIcon').textContent = subjectData.icon;
                renderDynamicMaterials(subjectId);
                renderOnlineExams(subjectId);
            } else {
                document.body.innerHTML = '<h1 style="text-align:center; margin-top:50px;">Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h1>';
            }

            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('user_email');
                localStorage.removeItem('user_display_name');
                localStorage.removeItem('user_role');
                localStorage.removeItem('is_master_admin');
                localStorage.removeItem('user_permitted_subjects');
                window.location.href = 'login.html';
            });

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.dataset.target;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(target).classList.add('active');

                    if (target === 'online_exams') renderOnlineExams(subjectId);
                });
            });
        });
    </script>
    <style>
        /* Context-specific subject tweaks */
        .tabs-container {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 60px;
            /* Below nav */
            z-index: 100;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tabs {
            display: flex;
            justify-content: flex-start;
            gap: 0.5rem;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .tab {
            padding: 1rem 1.2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 700;
            white-space: nowrap;
            color: #666;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .content-container {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Material Info Tweaks */
        .material-info {
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }

        .material-info h3 {
            font-size: 1.1rem;
            margin-bottom: 2px;
        }

        .action-btn {
            background: var(--primary-gradient);
            color: white;
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(13, 71, 161, 0.2);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(13, 71, 161, 0.3);
        }

        @media (max-width: 768px) {
            .tabs-container {
                top: 50px;
            }

            .tab {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }

            .material-info h3 {
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>
    <div id="security-overlay">
        <h2>âš ï¸ ØªØ­Ø°ÙŠØ± Ø£Ù…Ù†ÙŠ</h2>
        <p>ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø­Ø§ÙˆÙ„Ø© ØªØµÙˆÙŠØ± Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ø´Ø§Ø´Ø©.</p>
        <p>Ø³ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±.</p>
    </div>

    <nav class="main-nav">
        <div class="container nav-container">
            <a href="dashboard.html"
                style="color: white; text-decoration: none; font-weight:bold; display: flex; align-items: center; gap: 15px;">
                <img src="img/logo.jpg" alt="Logo" style="height: 50px; border-radius: 8px;">
                <span class="brand-text"
                    style="font-size: 2.5rem; font-weight: 900; letter-spacing: 2px; color: #ffd700; text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 15px rgba(255,215,0,0.6);">&larr;
                    ELMOHASEB ACADEMY</span>
            </a>

            <div class="nav-actions">
                <div class="user-profile">
                    <span id="welcomeMsg" class="welcome-msg">Ù…Ø±Ø­Ø¨Ø§</span>
                </div>
                <div class="nav-separator"></div>
                <button id="logoutBtn" class="logout-btn">Ø®Ø±ÙˆØ¬ ğŸšª</button>
            </div>
        </div>
    </nav>

    <div class="header-section">
        <div class="container">
            <div id="subjectIcon" class="header-icon"></div>
            <h1 id="subjectTitle">...</h1>
        </div>
    </div>

    <!-- Persistent Warning Banner Moved Here -->
    <div class="persistent-warning">
        <span>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø±Ø§Ù‚Ø¨ Ø¨Ø¹Ù„Ø§Ù…Ø© Ù…Ø§Ø¦ÙŠØ© Ø¨Ø§Ø³Ù…Ùƒ. Ø£ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØµÙˆÙŠØ± Ø³ØªØ¹Ø±Ø¶ Ø­Ø³Ø§Ø¨Ùƒ Ù„Ù„Ø­Ø¸Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.</span>
    </div>

    <div class="tabs-container">
        <div class="tabs">
            <div class="tab active" data-target="videos">ğŸ¥ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</div>
            <div class="tab" data-target="pdfs">ğŸ“š Ø§Ù„Ù…Ù„Ø§Ø²Ù… (PDF)</div>
            <div class="tab" data-target="exams">ğŸ“ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>
            <div class="tab" data-target="online_exams">ğŸ“ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</div>
            <div class="tab" data-target="sheets">ğŸ“ Ø§Ù„Ø´ÙŠØªØ§Øª</div>
        </div>
    </div>

    <div class="content-container">
        <div id="videos" class="content-section active"></div>
        <div id="pdfs" class="content-section"></div>
        <div id="sheets" class="content-section"></div>
        <div id="exams" class="content-section"></div>
        <div id="online_exams" class="content-section"></div>
    </div>

    <!-- Secure PDF Viewer Modal -->
    <div id="pdfViewerModal" class="secure-modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø¹Ø§Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¢Ù…Ù†</h3>
                <div>
                    <button class="icon-btn" onclick="toggleFullScreen('pdfViewerModal')"
                        title="ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø©">â›¶</button>
                    <button class="close-btn" onclick="closeModal('pdfViewerModal')" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
                </div>
            </div>
            <div class="modal-body"
                style="position: relative; text-align: center; background: #525659; padding: 1rem; height: 80vh; overflow-y: auto;">
                <div id="pdfContainer"></div>
            </div>
        </div>
    </div>

    <!-- Secure Video Player Modal -->
    <div id="videoPlayerModal" class="secure-modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¢Ù…Ù†</h3>
                <button class="close-btn" onclick="closeModal('videoPlayerModal')">Ã—</button>
            </div>
            <div id="videoBody" class="modal-body"
                style="background: black; display: flex; justify-content: center; align-items: center; min-height: 80vh;">
                <video id="secureVideo" controls controlsList="nodownload"
                    style="width: 100%; max-height: 80vh; display: none;"></video>
                <iframe id="youtubePlayer" style="width: 100%; height: 80vh; display: none;" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Online Exam Player Modal -->
    <div id="examPlayerModal" class="secure-modal" style="display:none;">
        <div class="modal-content" style="max-width:800px; height:auto; max-height:90vh;">
            <div class="modal-header">
                <h3 id="playerExamTitle">Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h3>
                <div id="examTimer" style="font-weight:bold; color:red; font-size:1.2rem;">00:00</div>
            </div>
            <div class="modal-body" style="padding:2rem;">
                <div id="questionContainer">
                    <!-- Questions will be rendered here -->
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:20px;">
                    <button class="action-btn" id="prevQBtn" onclick="changeQuestion(-1)"
                        style="background:#888;">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button class="action-btn" id="nextQBtn" onclick="changeQuestion(1)">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    <button class="action-btn" id="submitExamBtn" onclick="finishExam()"
                        style="background:#28a745; display:none;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .secure-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            width: 98%;
            height: 98%;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .pdf-page-canvas {
            margin-bottom: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .dynamic-watermark {
            position: absolute;
            pointer-events: none;
            opacity: 0.1;
            /* Very subtle for a large center logo */
            width: 70%;
            /* Large logo */
            height: auto;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            z-index: 10000;
            user-select: none;
        }

        /* --- Exam Review Styles --- */
        .review-q-item {
            text-align: right;
            border-bottom: 2px solid #eee;
            padding: 1.5rem 0;
            margin-bottom: 1rem;
        }

        .review-q-text {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 1rem;
        }

        .review-choices {
            display: grid;
            gap: 8px;
        }

        .review-choice {
            padding: 10px 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .review-choice.correct {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
            font-weight: bold;
        }

        .review-choice.incorrect {
            background: #ffebee;
            border-color: #ef5350;
            color: #c62828;
            text-decoration: line-through;
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-right: auto;
        }

        .status-badge.correct {
            background: #4caf50;
            color: white;
        }

        .status-badge.incorrect {
            background: #ef5350;
            color: white;
        }

        @media (max-width: 600px) {
            .dynamic-watermark {
                font-size: 1rem;
            }
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: 10px;
            color: #555;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        window.toggleFullScreen = function (modalId) {
            const modal = document.getElementById(modalId);
            if (!document.fullscreenElement) {
                modal.requestFullscreen().catch(err => {
                    alert(`Error: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        };

        window.closeModal = function (id) {
            document.getElementById(id).style.display = 'none';
            if (document.fullscreenElement) document.exitFullscreen();
            const video = document.getElementById('secureVideo');
            if (video) { video.pause(); video.src = ""; }
            const iframe = document.getElementById('youtubePlayer');
            if (iframe) iframe.src = "";
        };

        window.openSecurePDF = async function (url) {
            if (typeof pdfjsLib === 'undefined') {
                alert('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù€ PDF Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§.');
                return;
            }

            const modal = document.getElementById('pdfViewerModal');
            const container = document.getElementById('pdfContainer');
            // Try to get Full Name or Username
            const displayName = localStorage.getItem('user_display_name') || 'Student';
            const userIdentifier = displayName;

            modal.style.display = 'flex';
            container.innerHTML = '<div style="color:white; padding:20px;">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ø£Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø©... â³</div>';

            try {
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                container.innerHTML = '';

                // Optimization: Device Pixel Ratio for Sharpness
                const dpr = window.devicePixelRatio || 1;
                const qualityScale = dpr > 1 ? dpr : 2; // Minimum quality boost for clarity

                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);

                    // Calculate scale to fit container width
                    const initialViewport = page.getViewport({ scale: 1 });
                    const containerWidth = container.clientWidth - 40;
                    const scale = containerWidth / initialViewport.width;
                    const viewport = page.getViewport({ scale: scale });

                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    wrapper.style.display = 'block';
                    wrapper.style.margin = '15px auto';
                    wrapper.style.maxWidth = 'fit-content';
                    wrapper.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)';

                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');

                    // Set canvas resolution higher for clarity
                    canvas.width = viewport.width * qualityScale;
                    canvas.height = viewport.height * qualityScale;

                    // Set display size via CSS
                    canvas.style.width = viewport.width + 'px';
                    canvas.style.height = viewport.height + 'px';
                    canvas.className = 'pdf-page-canvas';
                    canvas.addEventListener('contextmenu', e => e.preventDefault());

                    const renderContext = {
                        canvasContext: context,
                        viewport: page.getViewport({ scale: scale * qualityScale }), // Render at high res
                        intent: 'display'
                    };

                    await page.render(renderContext).promise;

                    function addCenteredWatermark() {
                        const img = document.createElement('img');
                        img.src = 'img/logo.jpg';
                        img.className = 'dynamic-watermark';
                        return img;
                    }

                    wrapper.appendChild(canvas);
                    // Add single centered logo watermark
                    wrapper.appendChild(addCenteredWatermark());

                    container.appendChild(wrapper);
                }
            } catch (error) {
                container.innerHTML = '<p style="color:white; padding:20px;">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + error.message + '</p>';
            }
        };

        window.openSecureVideo = function (url) {
            const modal = document.getElementById('videoPlayerModal');
            const video = document.getElementById('secureVideo');
            const iframe = document.getElementById('youtubePlayer');

            modal.style.display = 'flex';
            const isYouTube = url.includes('youtube.com') || url.includes('youtu.be');
            const isGoogleDrive = url.includes('drive.google.com');

            if (isYouTube) {
                let videoId = "";
                if (url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];
                else if (url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1].split('?')[0];
                else if (url.includes('embed/')) videoId = url.split('embed/')[1].split('?')[0];
                else if (url.includes('shorts/')) videoId = url.split('shorts/')[1].split('?')[0];

                iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                iframe.style.display = 'block';
                video.style.display = 'none';
            } else if (isGoogleDrive) {
                let driveId = "";
                if (url.includes('/d/')) driveId = url.split('/d/')[1].split('/')[0];
                else if (url.includes('id=')) driveId = url.split('id=')[1].split('&')[0];

                if (driveId) {
                    iframe.src = `https://drive.google.com/file/d/${driveId}/preview`;
                    iframe.style.display = 'block';
                    video.style.display = 'none';
                }
            } else {
                video.src = url;
                video.style.display = 'block';
                iframe.style.display = 'none';
                video.play();
            }
        };
    </script>
    <script src="js/exams-builder.js?v=1.1"></script>
    <script>
        // --- Online Exams Student Logic ---
        let currentExam = null;
        let userAnswers = [];
        let currentQIndex = 0;
        let timerInterval = null;

        async function renderOnlineExams(subjectId) {
            const container = document.getElementById('online_exams');
            container.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª...';

            try {
                const exams = await window.ExamsBuilder.getAllExams(subjectId);
                container.innerHTML = '';

                if (exams.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#777; margin-top:2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                    return;
                }

                const now = new Date();
                const userId = localStorage.getItem('user_id');

                for (const exam of exams) {
                    const isOpen = exam.isOpen === true;

                    // Check for expiry (Skip ONLY if not Open Mode)
                    if (!isOpen && exam.expiryDate) {
                        const expiry = new Date(exam.expiryDate);
                        if (now > expiry) continue; // Skip expired exams
                    }

                    // Check for previous attempt (Fail-safe)
                    let attempt = null;
                    try {
                        if (userId) {
                            attempt = await window.ExamsBuilder.checkExamAttempt(userId, exam.$id);
                        }
                    } catch (attErr) {
                        console.warn("Could not check attempt status:", attErr);
                    }
                    const isTaken = attempt !== null;
                    // Bypass block if Open Mode
                    const canEnter = !isTaken || isOpen;

                    const div = document.createElement('div');
                    div.className = 'material-item';
                    div.style.opacity = (isTaken && !isOpen) ? '0.7' : '1';

                    div.innerHTML = `
                        <div class="material-info">
                            <div class="material-icon">${isTaken ? 'âœ…' : 'ğŸ“'}</div>
                            <div>
                                <h3>${exam.title} ${isOpen ? 'ğŸ”“' : ''}</h3>
                                <p style="color:#666; font-size:0.9rem;">
                                    ${exam.questions.length} Ø³Ø¤Ø§Ù„ - Ù…Ø¯Ø© ${exam.timeLimit} Ø¯Ù‚ÙŠÙ‚Ø©
                                    ${isTaken ? `<br><b style="color:#2e7d32;">Ø¢Ø®Ø± Ø¯Ø±Ø¬Ø©: ${attempt.score}/${attempt.total}</b>` : ''}
                                </p>
                            </div>
                        </div>
                        ${canEnter ?
                            `<button class="action-btn" onclick='startExam(${JSON.stringify(exam).replace(/'/g, "&apos;")})'>${isTaken ? 'Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' : 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†'}</button>` :
                            `<button class="action-btn" disabled style="background:#ccc;">ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø³Ø¨Ù‚Ø§Ù‹</button>`
                        }
                    `;
                    container.appendChild(div);
                }
            } catch (e) {
                container.innerHTML = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.';
            }
        }

        window.startExam = async (exam) => {
            const userId = localStorage.getItem('user_id');

            // Immediately mark as started to prevent re-entry
            try {
                await window.ExamsBuilder.saveExamResult(userId, exam.$id, 0, exam.questions.length);
            } catch (e) {
                console.error("Failed to mark start:", e);
            }

            currentExam = exam;
            userAnswers = new Array(exam.questions.length).fill(null);
            currentQIndex = 0;

            document.getElementById('playerExamTitle').textContent = exam.title;
            document.getElementById('examPlayerModal').style.display = 'flex';

            showQuestion(0);
            startTimer(exam.timeLimit * 60);
        };

        function showQuestion(index) {
            currentQIndex = index;
            const q = currentExam.questions[index];
            const container = document.getElementById('questionContainer');

            container.innerHTML = `
                <div style="font-size:1.2rem; font-weight:bold; margin-bottom:20px;">
                    Ø³Ø¤Ø§Ù„ ${index + 1} Ù…Ù† ${currentExam.questions.length}:<br>
                    ${q.text}
                </div>
                <div style="display:grid; gap:10px;">
                    ${q.choices.map((c, i) => `
                        <label style="display:flex; align-items:center; gap:10px; padding:15px; background:#f0f4f8; border-radius:8px; cursor:pointer; border:2px solid ${userAnswers[index] === i ? '#0d47a1' : 'transparent'};">
                            <input type="radio" name="choice" value="${i}" ${userAnswers[index] === i ? 'checked' : ''} onchange="selectAnswer(${i})">
                            ${c}
                        </label>
                    `).join('')}
                </div>
            `;

            document.getElementById('prevQBtn').style.display = index === 0 ? 'none' : 'block';
            document.getElementById('nextQBtn').style.display = index === currentExam.questions.length - 1 ? 'none' : 'block';
            document.getElementById('submitExamBtn').style.display = index === currentExam.questions.length - 1 ? 'block' : 'none';
        }

        window.selectAnswer = (i) => {
            userAnswers[currentQIndex] = i;
            showQuestion(currentQIndex); // Refresh UI for selection
        };

        window.changeQuestion = (dir) => {
            showQuestion(currentQIndex + dir);
        };

        function startTimer(seconds) {
            clearInterval(timerInterval);
            let remaining = seconds;
            const display = document.getElementById('examTimer');

            timerInterval = setInterval(() => {
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    alert("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†!");
                    finishExam();
                }
                remaining--;
            }, 1000);
        }

        window.finishExam = async () => {
            clearInterval(timerInterval);
            let score = 0;

            const reviewHtml = currentExam.questions.map((q, i) => {
                const isCorrect = userAnswers[i] === q.correctAnswer;
                if (isCorrect) score++;

                const choicesHtml = q.choices.map((c, cIdx) => {
                    let className = 'review-choice';
                    let badge = '';
                    if (cIdx === q.correctAnswer) {
                        className += ' correct';
                        badge = '<span class="status-badge correct">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© âœ…</span>';
                    } else if (cIdx === userAnswers[i]) {
                        className += ' incorrect';
                        badge = '<span class="status-badge incorrect">Ø¥Ø¬Ø§Ø¨ØªÙƒ âŒ</span>';
                    }
                    return `<div class="${className}">${c} ${badge}</div>`;
                }).join('');

                return `
                    <div class="review-q-item">
                        <div class="review-q-text">${i + 1}. ${q.text}</div>
                        <div class="review-choices">
                            ${choicesHtml}
                        </div>
                    </div>
                `;
            }).join('');

            const percent = Math.round((score / currentExam.questions.length) * 100);
            const userId = localStorage.getItem('user_id');

            // Feedback message based on score
            let feedbackMsg = "";
            if (percent >= 50) {
                feedbackMsg = `<p style="color: #2e7d32; font-weight: bold; margin-bottom: 15px;">Ø¨Ø·Ù„ ÙŠØ§ ÙˆØ­Ø´! Ø¹Ø§Ø´ Ø¬Ø¯Ø§Ù‹ØŒ ÙƒÙ…Ù„ ÙˆÙ…Ø³ØªÙˆØ§Ùƒ ÙÙŠ ØªØ­Ø³Ù† Ù…Ø³ØªÙ…Ø±. ğŸ”¥</p>`;
            } else {
                feedbackMsg = `<p style="color: #c62828; font-weight: bold; margin-bottom: 15px;">ÙˆÙ„Ø§ÙŠÙ‡Ù…Ùƒ ÙŠØ§ Ø¨Ø·Ù„ØŒ Ø¯ÙŠ Ù…Ø¬Ø±Ø¯ Ø¨Ø¯Ø§ÙŠØ©. Ø°Ø§ÙƒØ± Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¯ÙŠ ÙƒÙˆÙŠØ³ ÙˆÙ‡ØªÙƒØ³Ø± Ø§Ù„Ø¯Ù†ÙŠØ§ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø¬Ø§ÙŠØ©! ğŸ’ª</p>`;
            }

            // Save final result
            try {
                await window.ExamsBuilder.saveExamResult(userId, currentExam.$id, score, currentExam.questions.length);
            } catch (e) {
                console.error("Failed to save final score:", e);
            }

            const container = document.getElementById('questionContainer');
            container.innerHTML = `
                <div style="text-align:center; padding:1rem; border-bottom: 2px solid #0d47a1; margin-bottom: 2rem;">
                    <div style="font-size:3rem;">${percent >= 50 ? 'ğŸ‰' : 'ğŸ˜•'}</div>
                    <h2>Ù†ØªÙŠØ¬ØªÙƒ: ${score} Ù…Ù† ${currentExam.questions.length}</h2>
                    <p style="font-size:1.5rem; color:${percent >= 50 ? 'green' : 'red'}; font-weight:bold; margin-bottom:10px;">${percent}%</p>
                    ${feedbackMsg}
                    <button class="action-btn" style="margin-top:10px;" onclick="location.reload()">Ø¥ØºÙ„Ø§Ù‚ ÙˆØ¥Ù†Ù‡Ø§Ø¡</button>
                </div>
                <div style="max-height: 50vh; overflow-y: auto; padding-right: 10px;">
                    <h3 style="text-align:right; color:#0d47a1; margin-bottom:1rem;">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:</h3>
                    ${reviewHtml}
                </div>
            `;

            // Hide control buttons
            document.getElementById('prevQBtn').style.display = 'none';
            document.getElementById('nextQBtn').style.display = 'none';
            document.getElementById('submitExamBtn').style.display = 'none';
        };
    </script>
</body>

</html>