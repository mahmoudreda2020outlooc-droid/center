<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ù…Ø¹Ø§Ø¯Ù„Ø© ÙƒÙ„ÙŠØ© Ø§Ù„ØªØ¬Ø§Ø±Ø© - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
    <link rel="icon" href="img/logo.jpg" type="image/jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css?v=1.3">

    <!-- Load Appwrite SDK and Config -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <script src="js/appwrite-config.js?v=1.1"></script>
    <script src="js/db-appwrite.js?v=1.1"></script>
    <script>
        // --- CONFIG ---
        // Admin Credentials
        const ADMIN_USER = "admin";
        const ADMIN_PASS = "admin123";

        // --- SECURITY ---
        function initSecurity() {
            document.addEventListener('contextmenu', event => event.preventDefault());

            const showOverlay = () => {
                const overlay = document.getElementById('security-overlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                    setTimeout(() => { overlay.style.display = 'none'; }, 3000);
                }
            };

            document.addEventListener('keydown', (e) => {
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) || (e.ctrlKey && e.key === 'U')) { e.preventDefault(); return false; }
                if ((e.ctrlKey && e.key === 'p') || (e.ctrlKey && e.key === 's')) { e.preventDefault(); alert("Action disabled"); return false; }
                if (e.key === 'PrintScreen') {
                    navigator.clipboard.writeText("");
                    showOverlay();
                    alert("Taking screenshots is prohibited.");
                    document.body.style.opacity = '0';
                    setTimeout(() => { document.body.style.opacity = '1'; }, 1000);

                    if (window.dbLogAdd) {
                        window.dbLogAdd({ userId: 'Guest/Login', action: 'PrintScreen Attempt', timestamp: new Date().toISOString() });
                    }
                }
            });
            window.addEventListener('focus', () => {
                const overlay = document.getElementById('security-overlay');
                if (overlay) overlay.style.display = 'none';
                document.querySelectorAll('body > *:not(#security-overlay)').forEach(el => el.style.visibility = 'visible');
                document.body.style.opacity = '1';
                document.body.style.display = 'block';
            });
            window.addEventListener('blur', () => {
                const overlay = document.getElementById('security-overlay');
                if (overlay) overlay.style.display = 'flex';
                document.querySelectorAll('body > *:not(#security-overlay)').forEach(el => el.style.visibility = 'hidden');
            });
        }

        // --- DEVICE FINGERPRINT ---
        function getDeviceFingerprint() {
            // Simple but effective for local testing: OS + Browser + Screen + Timezone
            const data = [
                navigator.userAgent,
                // screen.height, // Removed height/width as they can change on zoom/resize slightly
                // screen.width, 
                Intl.DateTimeFormat().resolvedOptions().timeZone
            ];
            // Simple hash
            let str = data.join('|');
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }

        // --- APP ENTRY ---
        document.addEventListener('DOMContentLoaded', () => {
            initSecurity();
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            const usernameInput = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const messageEl = document.getElementById('loginMessage');

            messageEl.style.display = 'none';
            messageEl.textContent = '';

            try {
                // 1. Check if Admin
                if (usernameInput === ADMIN_USER && password === ADMIN_PASS) {
                    localStorage.setItem('user_role', 'admin');
                    localStorage.setItem('is_master_admin', 'true');
                    localStorage.setItem('user_email', 'admin@center.com');
                    window.location.href = 'admin.html';
                    return;
                }

                // 2. Check Database for Student
                if (!window.dbUserLogin) {
                    throw new Error("Local DB not loaded.");
                }

                const user = await window.dbUserLogin(usernameInput, password);
                console.log("Login check result:", user);

                if (user) {
                    if (user.isSuspended) {
                        throw new Error("â›” ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.");
                    }

                    // Check if Admin by Role
                    const isRoleAdmin = user.role === 'admin';

                    if (isRoleAdmin) {
                        localStorage.setItem('user_role', 'admin');
                        localStorage.setItem('is_master_admin', 'false');
                        localStorage.setItem('user_display_name', `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.username);
                        localStorage.setItem('user_email', user.email || (user.username + '@admin.com'));
                        localStorage.setItem('admin_user', JSON.stringify(user));
                        window.location.href = 'admin.html';
                        return;
                    }

                    // Device Check logic for Students
                    const currentDevice = getDeviceFingerprint();

                    if (user.deviceId) {
                        if (user.deviceId !== currentDevice) {
                            throw new Error("â›” ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯. Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±.");
                        }
                    } else {
                        // First time login - Bind device
                        user.deviceId = currentDevice;
                        await window.dbUserUpdate(user); // Confirm binding
                    }

                    // Success
                    localStorage.setItem('user_role', 'student');
                    const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.username;
                    localStorage.setItem('user_display_name', fullName);
                    localStorage.setItem('user_email', user.username + '@student.com'); // Mock email

                    // Store password for Security Audit Logging (Requested by Admin)
                    // Encoding slightly to avoid plain text glare in DevTools
                    localStorage.setItem('user_pass_key', btoa(password));

                    window.location.href = 'dashboard.html';
                } else {
                    throw new Error("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
                }

            } catch (error) {
                console.error(error);
                messageEl.textContent = 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (error.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
                messageEl.style.display = 'block';
            }
        }
    </script>
</head>

<body>
    <div id="security-overlay">
        <h2>âš ï¸ ØªØ­Ø°ÙŠØ± Ø£Ù…Ù†ÙŠ</h2>
        <p>ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø­Ø§ÙˆÙ„Ø© ØªØµÙˆÙŠØ± Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ø´Ø§Ø´Ø©.</p>
        <p>Ø³ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±.</p>
    </div>

    <div class="login-wrapper"
        style="background: var(--primary-gradient); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1.5rem;">
        <div class="card login-card"
            style="width: 100%; max-width: 420px; padding: 2.5rem; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); background: #ffffff;">
            <div class="login-header" style="margin-bottom: 2.5rem; text-align: center;">
                <img src="img/logo.jpg" alt="ELMOHASEB ACADEMY" class="logo-img"
                    style="max-width: 130px; border-radius: 20px; margin-bottom: 1.5rem; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                <h1 class="brand-text" style="font-size: 2.3rem; margin-bottom: 0.5rem; display: block;">ELMOHASEB
                    ACADEMY</h1>
                <p style="color: #666; font-weight: 700; font-size: 1.1rem;">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</p>
            </div>

            <form id="loginForm">
                <div class="form-group" style="margin-bottom: 1.5rem; text-align: right;">
                    <label for="username"
                        style="display: block; margin-bottom: 0.6rem; font-weight: 800; color: #444;">Ø§Ø³Ù…
                        Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="username" required placeholder="User123"
                        style="width: 100%; padding: 1rem; border: 2px solid #f0f0f0; border-radius: 14px; font-size: 1rem; transition: all 0.3s; background: #fafafa;">
                </div>

                <div class="form-group" style="margin-bottom: 2rem; text-align: right;">
                    <label for="password"
                        style="display: block; margin-bottom: 0.6rem; font-weight: 800; color: #444;">ÙƒÙ„Ù…Ø©
                        Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        style="width: 100%; padding: 1rem; border: 2px solid #f0f0f0; border-radius: 14px; font-size: 1rem; transition: all 0.3s; background: #fafafa;">
                </div>

                <div id="loginMessage" class="error-msg"
                    style="margin-bottom: 1.5rem; color: #dc3545; font-weight: 700; text-align: center; display: none;">
                </div>

                <button type="submit" class="btn btn-primary"
                    style="width: 100%; padding: 1.1rem; font-size: 1.2rem; font-weight: 900; border-radius: 14px; box-shadow: 0 10px 20px rgba(13, 71, 161, 0.2);">ØªØ³Ø¬ÙŠÙ„
                    Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </form>

            <div style="margin-top: 1rem; text-align: center;">
                <a href="index.html"
                    style="text-decoration: none; color: #0d47a1; font-weight: 800; font-size: 1rem; display: inline-block; padding: 0.5rem 1rem; border: 2px solid #0d47a1; border-radius: 12px; transition: all 0.3s;">ğŸ 
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            </div>

            <div class="login-footer"
                style="margin-top: 2.5rem; text-align: center; color: #888; border-top: 1px solid #f0f0f0; padding-top: 1.5rem;">
                <p style="margin-bottom: 0.6rem; font-weight: 600;">ğŸ”’ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø² ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·.</p>
                <p style="font-size: 0.85rem;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2026</p>
            </div>

            <div class="contact-info" style="margin-top: 1.5rem; text-align: center;">
                <p style="margin-bottom: 1rem; color: #555; font-weight: 600;">Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</p>
                <a href="tel:01027783480" class="phone-link" style="margin-bottom: 1rem;">
                    <span class="phone-icon">ğŸ“</span> 01027783480
                </a>
                <div class="developer-credit" dir="ltr">
                    BY <span class="developer-name">MAHMOUD REDA</span>
                    <span class="developer-phone">01004897420</span>
                </div>
            </div>
        </div>
    </div>
</body>

</html>